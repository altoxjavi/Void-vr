<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VOID WebXR Test</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #0a0a0f;
      color: #fff;
      font-family: system-ui, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    h1 { color: #ff2d7b; margin-bottom: 20px; }
    .status { 
      background: #1a1a2e;
      padding: 20px;
      border-radius: 10px;
      margin: 10px 0;
      width: 100%;
      max-width: 500px;
    }
    .status-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #333;
    }
    .status-item:last-child { border-bottom: none; }
    .pass { color: #0f0; }
    .fail { color: #f00; }
    .warn { color: #ff0; }
    button {
      background: linear-gradient(180deg, rgba(255,45,123,0.3) 0%, rgba(255,45,123,0.1) 100%);
      border: 1px solid rgba(255,45,123,0.5);
      color: #fff;
      padding: 15px 40px;
      font-size: 18px;
      cursor: pointer;
      margin: 20px 0;
      border-radius: 5px;
    }
    button:hover {
      background: linear-gradient(180deg, rgba(255,45,123,0.5) 0%, rgba(255,45,123,0.2) 100%);
    }
    button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    #vrStatus {
      padding: 20px;
      background: #1a1a2e;
      border-radius: 10px;
      margin-top: 20px;
      width: 100%;
      max-width: 500px;
    }
    canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
    }
    .instructions {
      background: #0f0f1a;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      max-width: 500px;
      font-size: 14px;
      line-height: 1.6;
    }
    .instructions h3 { color: #0ff; margin-bottom: 10px; }
    code {
      background: #2a2a3e;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <canvas id="glCanvas"></canvas>
  
  <h1>VOID WebXR Test</h1>
  
  <div class="status" id="diagnostics">
    <div class="status-item">
      <span>Secure Context (HTTPS)</span>
      <span id="secureStatus">checking...</span>
    </div>
    <div class="status-item">
      <span>navigator.xr</span>
      <span id="xrStatus">checking...</span>
    </div>
    <div class="status-item">
      <span>immersive-vr Support</span>
      <span id="vrSupportStatus">checking...</span>
    </div>
    <div class="status-item">
      <span>immersive-ar Support</span>
      <span id="arSupportStatus">checking...</span>
    </div>
    <div class="status-item">
      <span>WebGL Context</span>
      <span id="glStatus">checking...</span>
    </div>
    <div class="status-item">
      <span>XR Compatible GL</span>
      <span id="xrGlStatus">checking...</span>
    </div>
    <div class="status-item">
      <span>Running in iframe</span>
      <span id="iframeStatus">checking...</span>
    </div>
  </div>
  
  <button id="enterVR" disabled>Enter VR (Testing)</button>
  <button id="openNewWindow" style="background: linear-gradient(180deg, rgba(0,240,255,0.3) 0%, rgba(0,240,255,0.1) 100%); border-color: rgba(0,240,255,0.5);">
    ⧉ Open in New Window (for VR)
  </button>
  
  <div id="vrStatus"></div>
  
  <div class="instructions">
    <h3>If VR fails in preview:</h3>
    <p>Claude's preview iframe blocks WebXR permissions. Click <strong>"Open in New Window"</strong> to launch this page directly in the Quest browser - VR will work there!</p>
    <h3>Alternative - local testing:</h3>
    <ol>
      <li>Connect Quest to PC via USB</li>
      <li>Enable Developer Mode on Quest</li>
      <li>Run: <code>adb reverse tcp:8000 tcp:8000</code></li>
      <li>Start server: <code>python -m http.server 8000</code></li>
      <li>Open <code>http://localhost:8000</code> in Quest browser</li>
    </ol>
  </div>

<script>
// Diagnostic elements
const secureEl = document.getElementById('secureStatus');
const xrEl = document.getElementById('xrStatus');
const vrSupportEl = document.getElementById('vrSupportStatus');
const arSupportEl = document.getElementById('arSupportStatus');
const glEl = document.getElementById('glStatus');
const xrGlEl = document.getElementById('xrGlStatus');
const iframeEl = document.getElementById('iframeStatus');
const vrBtn = document.getElementById('enterVR');
const openWindowBtn = document.getElementById('openNewWindow');
const vrStatusEl = document.getElementById('vrStatus');

// Status helpers
const pass = (el, msg) => { el.textContent = msg || '✓ YES'; el.className = 'pass'; };
const fail = (el, msg) => { el.textContent = msg || '✗ NO'; el.className = 'fail'; };
const warn = (el, msg) => { el.textContent = msg; el.className = 'warn'; };

// Log to status div
function log(msg) {
  vrStatusEl.innerHTML += msg + '<br>';
  console.log('[VR Test]', msg);
}

// Check if running in iframe
const inIframe = window.self !== window.top;

// Open in new window using blob URL
openWindowBtn.addEventListener('click', () => {
  log('Opening in new window...');
  
  // Get the full HTML of this page
  const html = document.documentElement.outerHTML;
  
  // Create blob and open
  const blob = new Blob([html], { type: 'text/html' });
  const blobUrl = URL.createObjectURL(blob);
  
  const newWindow = window.open(blobUrl, '_blank');
  
  if (newWindow) {
    log('✓ New window opened! Try VR there.');
    // Clean up blob URL after a delay
    setTimeout(() => URL.revokeObjectURL(blobUrl), 5000);
  } else {
    log('✗ Popup blocked! Allow popups and try again.');
    alert('Popup was blocked. Please allow popups for this site and try again.');
  }
});

// Log to status div
function log(msg) {
  vrStatusEl.innerHTML += msg + '<br>';
  console.log('[VR Test]', msg);
}

// Run diagnostics
async function runDiagnostics() {
  log('Running WebXR diagnostics...');
  
  // 0. Check iframe status
  if (inIframe) {
    warn(iframeEl, '⚠ YES - may block VR');
    log('⚠ Running in iframe - WebXR may be blocked');
    log('  → Click "Open in New Window" for VR to work');
  } else {
    pass(iframeEl, '✓ NO (good!)');
    log('✓ Not in iframe');
  }
  
  // 1. Secure context
  if (window.isSecureContext) {
    pass(secureEl);
    log('✓ Secure context');
  } else {
    fail(secureEl);
    log('✗ NOT secure context - WebXR will fail!');
    log('  → Use HTTPS or localhost');
  }
  
  // 2. navigator.xr
  if (navigator.xr) {
    pass(xrEl);
    log('✓ navigator.xr exists');
  } else {
    fail(xrEl);
    log('✗ navigator.xr is undefined');
    log('  → WebXR not available in this browser');
    return;
  }
  
  // 3. immersive-vr support
  try {
    const vrSupported = await navigator.xr.isSessionSupported('immersive-vr');
    if (vrSupported) {
      pass(vrSupportEl);
      log('✓ immersive-vr supported');
      vrBtn.disabled = false;
    } else {
      fail(vrSupportEl);
      log('✗ immersive-vr not supported');
    }
  } catch (e) {
    fail(vrSupportEl, 'ERROR');
    log('✗ VR check error: ' + e.message);
  }
  
  // 4. immersive-ar support
  try {
    const arSupported = await navigator.xr.isSessionSupported('immersive-ar');
    if (arSupported) {
      pass(arSupportEl);
      log('✓ immersive-ar supported (passthrough available)');
    } else {
      warn(arSupportEl, '— NO');
      log('— immersive-ar not supported (OK, not required)');
    }
  } catch (e) {
    warn(arSupportEl, '— N/A');
  }
  
  // 5. WebGL context
  const canvas = document.getElementById('glCanvas');
  const gl = canvas.getContext('webgl2', { xrCompatible: true }) 
          || canvas.getContext('webgl', { xrCompatible: true });
  
  if (gl) {
    pass(glEl);
    log('✓ WebGL context created');
    
    // Store for VR session
    window.testGL = gl;
    window.testCanvas = canvas;
    
    // Check xrCompatible
    pass(xrGlEl, '✓ Created with xrCompatible');
    log('✓ GL context has xrCompatible flag');
    
  } else {
    fail(glEl);
    log('✗ Could not create WebGL context');
  }
  
  log('—— Diagnostics complete ——');
}

// VR Session test
let xrSession = null;

async function startVRTest() {
  log('');
  log('Attempting to start VR session...');
  
  // Try progressively simpler configs until one works
  const configs = [
    {
      name: 'Full features',
      options: {
        requiredFeatures: ['local-floor'],
        optionalFeatures: ['bounded-floor', 'hand-tracking']
      }
    },
    {
      name: 'Optional local-floor',
      options: {
        optionalFeatures: ['local-floor', 'bounded-floor', 'hand-tracking']
      }
    },
    {
      name: 'Minimal (no features)',
      options: {}
    }
  ];
  
  let session = null;
  let usedConfig = null;
  
  for (const config of configs) {
    try {
      log(`Trying: ${config.name}`);
      log('  Config: ' + JSON.stringify(config.options));
      
      session = await navigator.xr.requestSession('immersive-vr', config.options);
      usedConfig = config;
      log(`✓ SUCCESS with: ${config.name}`);
      break;
      
    } catch (e) {
      log(`✗ Failed: ${e.message}`);
    }
  }
  
  if (!session) {
    log('');
    log('ALL CONFIGURATIONS FAILED');
    log('This might be a browser/device issue.');
    return;
  }
  
  xrSession = session;
  
  try {
    // Create layer
    const gl = window.testGL;
    const layer = new XRWebGLLayer(session, gl);
    session.updateRenderState({ baseLayer: layer });
    log('✓ XRWebGLLayer created');
    
    // Get reference space - try multiple options
    let refSpace;
    const refSpaceTypes = ['local-floor', 'local', 'viewer'];
    
    for (const type of refSpaceTypes) {
      try {
        refSpace = await session.requestReferenceSpace(type);
        log(`✓ Got "${type}" reference space`);
        break;
      } catch (e) {
        log(`  "${type}" not available`);
      }
    }
    
    if (!refSpace) {
      log('✗ Could not get any reference space!');
      await session.end();
      return;
    }
    
    // Handle end
    session.addEventListener('end', () => {
      log('Session ended');
      xrSession = null;
      vrBtn.textContent = 'Enter VR (Testing)';
    });
    
    vrBtn.textContent = 'Exit VR';
    
    // Simple render loop - just clear to magenta so you know it's working
    let frameCount = 0;
    function onXRFrame(time, frame) {
      if (!xrSession) return;
      session.requestAnimationFrame(onXRFrame);
      
      const glLayer = session.renderState.baseLayer;
      gl.bindFramebuffer(gl.FRAMEBUFFER, glLayer.framebuffer);
      
      const pose = frame.getViewerPose(refSpace);
      if (!pose) return;
      
      for (const view of pose.views) {
        const vp = glLayer.getViewport(view);
        gl.viewport(vp.x, vp.y, vp.width, vp.height);
        
        // Cycle colors to show it's rendering
        const t = time / 1000;
        const r = Math.sin(t) * 0.3 + 0.3;
        const g = Math.sin(t + 2) * 0.1 + 0.1;
        const b = Math.sin(t + 4) * 0.3 + 0.4;
        
        gl.clearColor(r, g, b, 1.0);
        gl.clear(gl.COLOR_BUFFER_BIT);
      }
      
      frameCount++;
      if (frameCount % 90 === 0) {
        log('Rendering... frame ' + frameCount);
      }
    }
    
    session.requestAnimationFrame(onXRFrame);
    log('✓ Render loop started - you should see color cycling in VR!');
    
  } catch (e) {
    log('✗ Setup error: ' + e.message);
    if (xrSession) {
      await xrSession.end();
      xrSession = null;
    }
  }
}

async function stopVRTest() {
  if (xrSession) {
    await xrSession.end();
    xrSession = null;
  }
}

// Button handler
vrBtn.addEventListener('click', () => {
  if (xrSession) {
    stopVRTest();
  } else {
    startVRTest();
  }
});

// Run on load
runDiagnostics();
</script>
</body>
</html>
